<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Post Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        #logs { height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px; }
        .progress { height: 25px; }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">LinkedIn Post Generator</h1>
        <form id="submitForm">
            <div class="mb-3">
                <label for="post_idea" class="form-label">Post Idea:</label>
                <textarea class="form-control" id="post_idea" name="post_idea" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Generate LinkedIn Post</button>
        </form>
        <div id="status" class="alert mt-3 d-none"></div>
        <div id="progress-container" class="mt-4 d-none">
            <h3>Progress</h3>
            <div id="overall-progress" class="progress mb-3">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div id="task-progress"></div>
        </div>
        <h2 class="mt-4">Logs</h2>
        <div id="logs" class="border p-3 bg-light"></div>
        <div id="result-container" class="mt-4 d-none">
            <h2>Generated LinkedIn Post</h2>
            <div id="post-content" class="border p-3 bg-white"></div>
            <div id="post-hashtags" class="mt-2"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const socket = io();
    const statusElement = document.getElementById('status');
    const logsDiv = document.getElementById('logs');
    const progressContainer = document.getElementById('progress-container');
    const overallProgress = document.getElementById('overall-progress').querySelector('.progress-bar');
    const taskProgress = document.getElementById('task-progress');
    const resultContainer = document.getElementById('result-container');
    const postContent = document.getElementById('post-content');
    const postHashtags = document.getElementById('post-hashtags');

    socket.on('connect', () => {
        console.log('Connected to server');
        updateStatus('Connected to server', 'info');
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
        updateStatus('Disconnected from server. Please refresh the page.', 'warning');
    });

    socket.on('log', (data) => {
        addLogEntry(data.message);
    });

    socket.on('step_update', (data) => {
        addLogEntry(data.message);
    });

    socket.on('progress', (data) => {
        progressContainer.classList.remove('d-none');
        if (data.task === 'Overall') {
            updateOverallProgress(data.progress);
        } else {
            updateTaskProgress(data.task, data.progress);
        }
    });

    function addLogEntry(message) {
        const logEntry = document.createElement('div');
        logEntry.textContent = message;
        logsDiv.appendChild(logEntry);
        logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function updateOverallProgress(progress) {
        overallProgress.style.width = `${progress}%`;
        overallProgress.textContent = `${progress}%`;
        overallProgress.setAttribute('aria-valuenow', progress);
    }

    function updateTaskProgress(task, progress) {
        const taskId = `progress-${task.replace(/\s+/g, '-').toLowerCase()}`;
        let taskBar = document.getElementById(taskId);
        if (!taskBar) {
            taskBar = createTaskProgressBar(task, taskId);
        }
        const progressBar = taskBar.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${task}: ${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
        }
    }

    function createTaskProgressBar(task, taskId) {
        const taskBar = document.createElement('div');
        taskBar.className = 'progress mb-2';
        taskBar.innerHTML = `
            <div id="${taskId}" class="progress-bar" role="progressbar" 
                style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                ${task}: 0%
            </div>`;
        taskProgress.appendChild(taskBar);
        return taskBar;
    }

    function submitForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        updateStatus('Submitting...', 'info');
        
        fetch('/submit', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                updateStatus('Task submitted. Processing...', 'info');
                resetProgress();
                checkStatus(data.task_id);
            })
            .catch(error => updateStatus('Error submitting task: ' + error.message, 'danger'));
    }

    function checkStatus(taskId) {
        fetch('/results/' + taskId)
            .then(response => response.json())
            .then(data => {
                if (data.state === 'SUCCESS') {
                    updateStatus('Task completed successfully!', 'success');
                    displayResults(data.result);
                } else if (data.state === 'FAILURE') {
                    updateStatus('Task failed. Please try again.', 'danger');
                } else if (data.state === 'PROGRESS') {
                    updateTaskProgress(data.task, data.progress);
                    setTimeout(() => checkStatus(taskId), 1000);
                } else {
                    setTimeout(() => checkStatus(taskId), 1000);
                }
            })
            .catch(error => updateStatus('Error checking status: ' + error.message, 'danger'));
    }

    function updateStatus(message, type) {
        statusElement.textContent = message;
        statusElement.className = `alert mt-3 alert-${type}`;
        statusElement.classList.remove('d-none');
    }

    function resetProgress() {
        progressContainer.classList.add('d-none');
        updateOverallProgress(0);
        taskProgress.innerHTML = '';
        resultContainer.classList.add('d-none');
    }

    function displayResults(result) {
        resultContainer.classList.remove('d-none');
        resultJSON = JSON.parse(result);
        postContent.textContent = resultJSON.content.replace(/\\n/g, '<br>');
        postContent.textContent = resultJSON.content.replace(/\n/g, '<br>');
        postHashtags.textContent = resultJSON.hashtags.join(' ');
    }

    document.getElementById('submitForm').addEventListener('submit', submitForm);
    </script>
</body>
</html>